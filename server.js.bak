import 'dotenv/config';
import express from 'express';
import cors from 'cors';
import { ProxyAgent } from 'undici';
import { DatabaseService } from './src/lib/database.js';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = 1062;

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð¾ÐºÑÐ¸ Ð´Ð»Ñ Undici (Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ð¹ fetch Ð² Node.js)
// const PROXY_URL = process.env.PROXY_URL || 'http://pb3jms:85pNLX@45.147.180.58:8000';
// const proxyAgent = new ProxyAgent({
//   uri: PROXY_URL
// });
const proxyAgent = undefined; // Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐºÑÐ¸ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ fetch Ñ Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¼ Ð¿Ñ€Ð¾ÐºÑÐ¸
const fetchWithProxy = (url, options = {}) => {
  if (proxyAgent) {
    return fetch(url, { ...options, dispatcher: proxyAgent });
  }
  return fetch(url, options);
};

// Middleware
app.use(cors({
  origin: ['https://ai.windexs.ru', 'https://www.ai.windexs.ru', 'http://ai.windexs.ru', 'http://www.ai.windexs.ru'],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));
app.use(express.json());

// API Routes

// Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð½Ð¾Ð²ÑƒÑŽ ÑÐµÑÑÐ¸ÑŽ Ñ‡Ð°Ñ‚Ð°
app.post('/api/sessions', (req, res) => {
  try {
    const { title = 'ÐÐ¾Ð²Ñ‹Ð¹ Ñ‡Ð°Ñ‚' } = req.body;
    const sessionId = DatabaseService.createSession(title);
    res.json({ sessionId });
  } catch (error) {
    console.error('Error creating session:', error);
    res.status(500).json({ error: 'Failed to create session' });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð²ÑÐµ ÑÐµÑÑÐ¸Ð¸
app.get('/api/sessions', (req, res) => {
  try {
    const sessions = DatabaseService.getAllSessions();
    res.json(sessions);
  } catch (error) {
    console.error('Error getting sessions:', error);
    res.status(500).json({ error: 'Failed to get sessions' });
  }
});

// ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ÑÐµÑÑÐ¸Ð¸
app.get('/api/sessions/:sessionId/messages', (req, res) => {
  try {
    const { sessionId } = req.params;
    const messages = DatabaseService.loadMessages(parseInt(sessionId));
    res.json(messages);
  } catch (error) {
    console.error('Error getting messages:', error);
    res.status(500).json({ error: 'Failed to get messages' });
  }
});

// Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
app.post('/api/messages', (req, res) => {
  try {
    const { sessionId, role, content } = req.body;

    if (!sessionId || !role || !content) {
      return res.status(400).json({ error: 'Missing required fields' });
    }

    const messageId = DatabaseService.saveMessage(sessionId, role, content);
    res.json({ messageId });
  } catch (error) {
    console.error('Error saving message:', error);
    res.status(500).json({ error: 'Failed to save message' });
  }
});

// ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº ÑÐµÑÑÐ¸Ð¸
app.patch('/api/sessions/:sessionId', (req, res) => {
  try {
    const { sessionId } = req.params;
    const { title } = req.body;

    if (!title) {
      return res.status(400).json({ error: 'Title is required' });
    }

    DatabaseService.updateSessionTitle(parseInt(sessionId), title);
    res.json({ success: true });
  } catch (error) {
    console.error('Error updating session title:', error);
    res.status(500).json({ error: 'Failed to update session title' });
  }
});

// Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÐµÑÑÐ¸ÑŽ
app.delete('/api/sessions/:sessionId', (req, res) => {
  try {
    const { sessionId } = req.params;
    DatabaseService.deleteSession(parseInt(sessionId));
    res.json({ success: true });
  } catch (error) {
    console.error('Error deleting session:', error);
    res.status(500).json({ error: 'Failed to delete session' });
  }
});

// Ð’ÐµÐ±-Ð¿Ð¾Ð¸ÑÐº Ñ‡ÐµÑ€ÐµÐ· backend (Ð¾Ð±Ñ…Ð¾Ð´ CORS Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹)
app.get('/api/web-search', async (req, res) => {
  try {
    const { q: query } = req.query;

    if (!query || typeof query !== 'string') {
      return res.status(400).json({ error: 'Query parameter is required' });
    }

    const encodedQuery = encodeURIComponent(query);
    const lowerQuery = query.toLowerCase();
    let searchResults = '';

    // 1. ÐŸÐ¾Ð¸ÑÐº ÐºÑƒÑ€ÑÐ¾Ð² ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚ (Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ°)
    const isCryptoQuery = lowerQuery.includes('ÐºÑƒÑ€Ñ') || lowerQuery.includes('Ñ†ÐµÐ½Ð°') || lowerQuery.includes('ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ') ||
        lowerQuery.includes('ÐºÑ€Ð¸Ð¿Ñ‚Ð¾') || lowerQuery.includes('Ð±Ð¸Ñ‚ÐºÐ¾Ð¸Ð½') || lowerQuery.includes('ethereum') ||
        lowerQuery.includes('bitcoin') || lowerQuery.includes('Ð¼Ð¸ÐºÑ€Ð¾') || /\b(mbc|btc|eth)\b/i.test(lowerQuery);

    // ÐŸÐ¾Ð¸ÑÐº ÐºÑƒÑ€ÑÐ¾Ð² ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚
    if (isCryptoQuery) {
      try {

        // Ð˜Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ðµ ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚Ñ‹
        let cryptoIds = [];
        if (lowerQuery.includes('Ð±Ð¸Ñ‚ÐºÐ¾Ð¸Ð½') || lowerQuery.includes('bitcoin') || lowerQuery.includes('btc')) cryptoIds.push('bitcoin');
        if (lowerQuery.includes('ethereum') || lowerQuery.includes('ÑÑ„Ð¸Ñ€') || lowerQuery.includes('eth')) cryptoIds.push('ethereum');

        // Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ»ÑƒÑ‡Ð°Ð¸
        if (lowerQuery.includes('Ð¼Ð¸ÐºÑ€Ð¾') && lowerQuery.includes('Ð±Ð¸Ñ‚ÐºÐ¾Ð¸Ð½')) {
          cryptoIds.push('microbitcoin');
        }


        if (cryptoIds.length > 0) {
          const cryptoResponse = await fetchWithProxy(`https://api.coingecko.com/api/v3/simple/price?ids=${cryptoIds.join(',')}&vs_currencies=usd,rub,eur&include_24hr_change=true&include_market_cap=true&include_24hr_vol=true`, {
            headers: {
              'User-Agent': 'Mozilla/5.0 (compatible; WindexsAI/1.0)',
              'Accept': 'application/json'
            }
          });

          if (cryptoResponse.ok) {
            const cryptoData = await cryptoResponse.json();

            searchResults += `ÐšÑƒÑ€ÑÑ‹ Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐºÑ€Ð¸Ð¿Ñ‚Ð¾Ð²Ð°Ð»ÑŽÑ‚:\n\n`;

            for (const cryptoId of cryptoIds) {
              if (cryptoData[cryptoId]) {
                const data = cryptoData[cryptoId];
                const name = cryptoId.charAt(0).toUpperCase() + cryptoId.slice(1);
                searchResults += `${name}:\n`;
                searchResults += `ðŸ’° Ð¦ÐµÐ½Ð°: $${data.usd} / â‚½${data.rub} / â‚¬${data.eur}\n`;

                if (data.usd_24h_change !== undefined) {
                  const change = data.usd_24h_change.toFixed(2);
                  const changeIcon = parseFloat(change) >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰';
                  searchResults += `${changeIcon} Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ 24Ñ‡: ${change}%\n`;
                }

                if (data.usd_market_cap) {
                  searchResults += `ðŸ“Š ÐšÐ°Ð¿Ð¸Ñ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ: $${data.usd_market_cap.toLocaleString()}\n`;
                }

                if (data.usd_24h_vol) {
                  searchResults += `ðŸ“Š ÐžÐ±ÑŠÐµÐ¼ 24Ñ‡: $${data.usd_24h_vol.toLocaleString()}\n`;
                }

                searchResults += '\n';
              }
            }
          }
        }
      } catch (cryptoError) {
        console.error('Crypto API error:', cryptoError);
      }
    }

    // 2. ÐŸÐ¾Ð¸ÑÐº Ð² DuckDuckGo Instant Answer API (Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ñ€ÑƒÑÑÐºÐ¸Ð¹ Ð¸ Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ð¹)
    try {
      console.log('Searching DuckDuckGo for:', query);

      // Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ
      let instantResponse = await fetchWithProxy(`https://api.duckduckgo.com/?q=${encodedQuery}&format=json&no_redirect=1&no_html=1`);
      let instantData = null;

      if (instantResponse.ok) {
        instantData = await instantResponse.json();
        console.log('DuckDuckGo original query data keys:', Object.keys(instantData));
      }

      // Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¸ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÐ²ÐµÑÑ‚Ð¸ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð°
      if ((!instantData || !instantData.AbstractText) && lowerQuery.includes('Ñ‡Ñ‚Ð¾')) {
        const englishQuery = query
          .replace(/Ñ‡Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ/i, 'what is')
          .replace(/ÐºÑ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ð¹/i, 'who is')
          .replace(/Ð³Ð´Ðµ/i, 'where')
          .replace(/ÐºÐ°Ðº/i, 'how')
          .replace(/Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ/i, 'why')
          .replace(/Ð±Ð¸Ñ‚ÐºÐ¾Ð¸Ð½/i, 'bitcoin')
          .replace(/ÐºÑ€Ð¸Ð¿Ñ‚Ð¾/i, 'crypto')
          .replace(/javascript/i, 'javascript')
          .replace(/Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½/i, 'programming');

        console.log('Trying English query:', englishQuery);
        const englishResponse = await fetchWithProxy(`https://api.duckduckgo.com/?q=${encodeURIComponent(englishQuery)}&format=json&no_redirect=1&no_html=1`);

        if (englishResponse.ok) {
          instantData = await englishResponse.json();
          console.log('DuckDuckGo English query data keys:', Object.keys(instantData));
        }
      }

      if (instantData) {
        if (instantData.Answer) {
          searchResults += `ÐžÑ‚Ð²ÐµÑ‚: ${instantData.Answer}\n\n`;
        }
        if (instantData.AbstractText) {
          searchResults += `Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ: ${instantData.AbstractText}\n\n`;
        }
        if (instantData.Definition) {
          searchResults += `ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ: ${instantData.Definition}\n\n`;
        }
        if (instantData.Heading) {
          searchResults += `Ð¢ÐµÐ¼Ð°: ${instantData.Heading}\n\n`;
        }

        // RelatedTopics
        if (instantData.RelatedTopics && Array.isArray(instantData.RelatedTopics)) {
          const topics = instantData.RelatedTopics.slice(0, 3);
          if (topics.length > 0) {
            searchResults += 'Ð¡Ð²ÑÐ·Ð°Ð½Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ:\n';
            topics.forEach((topic, index) => {
              if (topic.Text && topic.Text.length > 10) {
                searchResults += `${index + 1}. ${topic.Text}\n`;
              }
            });
            searchResults += '\n';
          }
        }
      }
    } catch (instantError) {
      console.error('DuckDuckGo Instant Answer error:', instantError);
    }

    // 3. ÐŸÐ¾Ð¸ÑÐº Ð² Wikipedia
    try {
      const wikiQuery = query.replace(/\s+/g, '_');

      // Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ñ€ÑƒÑÑÐºÐ¸Ð¹
      let wikiResponse = await fetchWithProxy(`https://ru.wikipedia.org/api/rest_v1/page/summary/${wikiQuery}`);
      if (!wikiResponse.ok) {
        // Ð•ÑÐ»Ð¸ Ñ€ÑƒÑÑÐºÐ¸Ð¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ð¹
        wikiResponse = await fetchWithProxy(`https://en.wikipedia.org/api/rest_v1/page/summary/${wikiQuery}`);
      }

      if (wikiResponse.ok) {
        const wikiData = await wikiResponse.json();
        if (wikiData.extract) {
          searchResults += `Ð˜Ð· Wikipedia: ${wikiData.extract}\n\n`;
          if (wikiData.description) {
            searchResults += `ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ: ${wikiData.description}\n\n`;
          }
        }
      }
    } catch (wikiError) {
      console.error('Wikipedia search error:', wikiError);
    }

    // 4. ÐŸÐ¾Ð¸ÑÐº Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ð¹ Ñ‡ÐµÑ€ÐµÐ· Glosbe
    if (lowerQuery.includes('Ñ‡Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ') || lowerQuery.includes('Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ')) {
      try {
        const term = query.replace(/Ñ‡Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ\s+/i, '').replace(/Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ\s+/i, '').trim();
        const glosbeResponse = await fetchWithProxy(`https://glosbe.com/gapi/translate?from=ru&dest=en&format=json&phrase=${encodeURIComponent(term)}`);

        if (glosbeResponse.ok) {
          const glosbeData = await glosbeResponse.json();
          if (glosbeData.tuc && glosbeData.tuc.length > 0) {
            searchResults += `ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ Ð¸ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ñ‹:\n`;
            glosbeData.tuc.slice(0, 3).forEach((entry, index) => {
              if (entry.meanings && entry.meanings.length > 0) {
                entry.meanings.slice(0, 2).forEach((meaning) => {
                  if (meaning.text) {
                    searchResults += `${index + 1}. ${meaning.text}\n`;
                  }
                });
              }
            });
            searchResults += '\n';
          }
        }
      } catch (dictError) {
        console.error('Dictionary search error:', dictError);
      }
    }

    // 5. Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº Ð´Ð»Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾ Ð±Ð¸Ð·Ð½ÐµÑÐµ/Ñ„Ð¸Ð½Ð°Ð½ÑÐ°Ñ…/Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚Ð¸
    if (lowerQuery.includes('Ð¿Ñ€Ð¸Ð±Ñ‹Ð»') || lowerQuery.includes('Ð´Ð¾Ñ…Ð¾Ð´') || lowerQuery.includes('Ð²Ñ‹Ñ€ÑƒÑ‡Ðº') ||
        lowerQuery.includes('Ð¿Ñ€Ð¾Ð´Ð°Ð¶') || lowerQuery.includes('Ð±Ð¸Ð·Ð½ÐµÑ') || lowerQuery.includes('ÐºÐ¾Ñ„Ðµ') ||
        lowerQuery.includes('Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚') || lowerQuery.includes('ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€') || lowerQuery.includes('Ð¶Ð¸Ð»') ||
        lowerQuery.includes('Ð´Ð¾Ð¼') || lowerQuery.includes('Ñ€Ñ‹Ð½Ð¾Ðº Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚')) {

      console.log('Business data search for:', query);

      // ÐŸÐ¾Ð¸ÑÐº Ð² Google Ñ‡ÐµÑ€ÐµÐ· Ð¿Ð¾Ð¸ÑÐºÐ¾Ð²Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹
      try {
        // Ð˜Ñ‰ÐµÐ¼ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÑƒÑŽ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ð¾ Ð±Ð¸Ð·Ð½ÐµÑÐµ/Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² Ð Ð¾ÑÑÐ¸Ð¸/ÐœÐ¾ÑÐºÐ²Ðµ Ñ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ†Ð¸Ñ„Ñ€Ð°Ð¼Ð¸
        const businessQueries = lowerQuery.includes('Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚') || lowerQuery.includes('ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€') || lowerQuery.includes('Ð¶Ð¸Ð»') ? [
          'Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸ ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð³Ð¾Ð´ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾',
          'ÑÑ€ÐµÐ´Ð½ÑÑ Ñ†ÐµÐ½Ð° ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ñ‹ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð¼Ð»Ð½ Ñ€ÑƒÐ±Ð»ÐµÐ¹',
          'Ð´Ð¸Ð½Ð°Ð¼Ð¸ÐºÐ° Ð¿Ñ€Ð¾Ð´Ð°Ð¶ Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¼Ð¾ÑÐºÐ²Ð° 2024',
          'Ñ€Ñ‹Ð½Ð¾Ðº Ð¶Ð¸Ð»Ð¾Ð¹ Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð¾Ñ‚Ñ‡ÐµÑ‚',
          'ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ñ€Ð¾Ð´Ð°Ð¶ ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€ Ð¼Ð¾ÑÐºÐ²Ð° 2024 ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ñ†Ð¸Ñ„Ñ€Ñ‹',
          'Ñ†ÐµÐ½Ñ‹ Ð½Ð° Ð¶Ð¸Ð»ÑŒÐµ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð³Ð¾Ð´ Ñ‚Ð¾Ñ‡Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ',
          'Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚ Ñ€Ñ‹Ð½ÐºÐ° Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð¼Ð»Ð½ Ñ€ÑƒÐ±',
          'Ð°Ð½Ð°Ð»Ð¸Ð· Ñ€Ñ‹Ð½ÐºÐ° Ð¶Ð¸Ð»ÑŒÑ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚',
          'Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸ Ð´Ð¾Ð¼Ð¾Ð² Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð¼Ð»Ñ€Ð´ Ñ€ÑƒÐ±Ð»ÐµÐ¹',
          'Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð³Ð¾Ð´ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹',
          'ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÐ´ÐµÐ»Ð¾Ðº Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ñ‚Ñ‹Ñ',
          'ÑÑ€ÐµÐ´Ð½ÑÑ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¶Ð¸Ð»ÑŒÑ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ñ†Ð¸Ñ„Ñ€Ñ‹',
          'Ñ€Ð¾ÑÑ‚ Ñ†ÐµÐ½ Ð½Ð° ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ñ‹ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð¼Ð»Ð½',
          'ÑÐ¿Ñ€Ð¾Ñ Ð½Ð° Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚',
          'ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸ÐºÐ° Ñ€Ñ‹Ð½ÐºÐ° Ð¶Ð¸Ð»ÑŒÑ Ñ€Ð¾ÑÑÐ¸Ñ 2024 ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ'
        ] : [
          'ÑÑ€ÐµÐ´Ð½ÑÑ Ð¿Ñ€Ð¸Ð±Ñ‹Ð»ÑŒ ÐºÐ¾Ñ„ÐµÐ¹Ð½Ð¸ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð³Ð¾Ð´ Ñ†Ð¸Ñ„Ñ€Ñ‹',
          'Ð²Ñ‹Ñ€ÑƒÑ‡ÐºÐ° ÐºÐ¾Ñ„ÐµÐµÐ½ Ð¼Ð¾ÑÐºÐ²Ð° Ð·Ð° 2024 Ð³Ð¾Ð´ Ð¼Ð»Ð½ Ñ€ÑƒÐ±Ð»ÐµÐ¹',
          'Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ðµ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»Ð¸ ÐºÐ¾Ñ„ÐµÐµÐ½ Ñ€Ð¾ÑÑÐ¸Ñ 2024 Ð¾Ñ‚Ñ‡ÐµÑ‚',
          'Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¾ Ñ€Ñ‹Ð½ÐºÐµ ÐºÐ¾Ñ„ÐµÐµÐ½ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð³Ð¾Ð´ Ð´Ð°Ð½Ð½Ñ‹Ðµ',
          'ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ñ€Ð¸Ð±Ñ‹Ð»Ð¸ ÐºÐ°Ñ„Ðµ Ñ€Ð¾ÑÑÐ¸Ñ 2024 ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ñ†Ð¸Ñ„Ñ€Ñ‹',
          'Ð´Ð¾Ñ…Ð¾Ð´Ñ‹ ÐºÐ¾Ñ„ÐµÐµÐ½ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð³Ð¾Ð´ Ñ‚Ð¾Ñ‡Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ',
          'Ð¸Ð·Ð´ÐµÑ€Ð¶ÐºÐ¸ ÐºÐ¾Ñ„ÐµÐ¹Ð½Ð¾Ð³Ð¾ Ð±Ð¸Ð·Ð½ÐµÑÐ° Ñ€Ð¾ÑÑÐ¸Ñ 2024 Ð¼Ð»Ð½ Ñ€ÑƒÐ±',
          'Ñ€ÐµÐ½Ñ‚Ð°Ð±ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ ÐºÐ¾Ñ„ÐµÐµÐ½ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚',
          'Ð¾Ð±Ð¾Ñ€Ð¾Ñ‚ Ñ€Ñ‹Ð½ÐºÐ° ÐºÐ¾Ñ„ÐµÐµÐ½ Ñ€Ð¾ÑÑÐ¸Ñ 2024 Ð¼Ð»Ñ€Ð´ Ñ€ÑƒÐ±Ð»ÐµÐ¹',
          'Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· ÐºÐ¾Ñ„ÐµÐµÐ½ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð³Ð¾Ð´ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹',
          'Ð¿Ñ€Ð¸Ð±Ñ‹Ð»ÑŒ ÐºÐ¾Ñ„ÐµÐ¹Ð½Ð¸ Ð¼Ð¾ÑÐºÐ²Ð° ÑÑ€ÐµÐ´Ð½ÑÑ 2024 Ñ‚Ñ‹Ñ Ñ€ÑƒÐ±',
          'Ð²Ñ‹Ñ€ÑƒÑ‡ÐºÐ° ÐºÐ°Ñ„Ðµ Ð¼Ð¾ÑÐºÐ²Ð° Ð³Ð¾Ð´Ð¾Ð²Ð°Ñ 2024 Ñ†Ð¸Ñ„Ñ€Ñ‹',
          'Ð·Ð°Ñ‚Ñ€Ð°Ñ‚Ñ‹ ÐºÐ¾Ñ„ÐµÐ¹Ð½Ð¾Ð³Ð¾ Ð±Ð¸Ð·Ð½ÐµÑÐ° Ñ€Ð¾ÑÑÐ¸Ñ 2024 Ð¼Ð»Ð½',
          'Ð´Ð¾Ñ…Ð¾Ð´Ð½Ð¾ÑÑ‚ÑŒ ÐºÐ¾Ñ„ÐµÐµÐ½ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚ Ñ€ÐµÐ½Ñ‚Ð°Ð±ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸',
          'ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸ÐºÐ° ÐºÐ¾Ñ„ÐµÐ¹Ð½Ð¾Ð³Ð¾ Ñ€Ñ‹Ð½ÐºÐ° Ñ€Ð¾ÑÑÐ¸Ñ 2024 ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ'
        ];

        for (const businessQuery of businessQueries) {
          try {
            const businessSearch = await fetchWithProxy(`https://api.duckduckgo.com/?q=${encodeURIComponent(businessQuery)}&format=json&no_html=1&skip_disambig=1`);
            if (businessSearch.ok) {
              const data = await businessSearch.json();
              console.log(`Business search results for "${businessQuery}":`, data.AbstractText);

              if (data.AbstractText && data.AbstractText.length > 20) {
                searchResults += `Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾ Ñ€Ñ‹Ð½ÐºÐµ ÐºÐ¾Ñ„ÐµÐµÐ½ (${businessQuery}):\n`;
                searchResults += `${data.AbstractText}\n\n`;
              }

              if (data.Answer && data.Answer.length > 10) {
                searchResults += `ÐžÑ‚Ð²ÐµÑ‚: ${data.Answer}\n\n`;
              }
            }
          } catch (queryError) {
            console.error('Business query error:', queryError);
          }
        }

        // ÐŸÐ¾Ð¸ÑÐº Ð² Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ°Ñ… ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸
        try {
          // ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð½Ð°Ð¹Ñ‚Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð Ð¾ÑÑÑ‚Ð°Ñ‚Ð° Ñ‡ÐµÑ€ÐµÐ· Ð¿Ð¾Ð¸ÑÐº
          const officialQueries = lowerQuery.includes('Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚') || lowerQuery.includes('ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€') || lowerQuery.includes('Ð¶Ð¸Ð»') ? [
            'Ñ€Ð¾ÑÑÑ‚Ð°Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ Ñ€Ñ‹Ð½ÐºÐµ Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚Ð¸ 2024',
            'ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ñ€Ð¾Ð´Ð°Ð¶ ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€ Ð¼Ð¾ÑÐºÐ²Ð° 2024',
            'Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ Ñ†ÐµÐ½Ð°Ñ… Ð½Ð° Ð¶Ð¸Ð»ÑŒÐµ Ñ€Ð¾ÑÑÐ¸Ñ',
            'Ð³Ð¾ÑÐºÐ¾Ð¼ÑÑ‚Ð°Ñ‚ Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð³Ð¾Ð´',
            'Ñ„ÐµÐ´ÐµÑ€Ð°Ð»ÑŒÐ½Ð°Ñ ÑÐ»ÑƒÐ¶Ð±Ð° Ð³Ð¾ÑÑƒÐ´Ð°Ñ€ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð¹ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ ÐºÐ°Ð´Ð°ÑÑ‚Ñ€Ð° Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚Ð¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° 2024',
            'Ð¼Ð¸Ð½ÑÑ‚Ñ€Ð¾Ð¹ Ñ€Ñ„ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ Ñ€Ñ‹Ð½ÐºÐµ Ð¶Ð¸Ð»ÑŒÑ 2024'
          ] : [
            'Ñ€Ð¾ÑÑÑ‚Ð°Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ Ð¾Ð±Ñ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð¼ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ð¸ 2024',
            'ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° ÐºÐ°Ñ„Ðµ Ð¸ Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ð¾Ð² Ð¼Ð¾ÑÐºÐ²Ð° 2024',
            'Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ Ð¿Ñ€Ð¸Ð±Ñ‹Ð»Ð¸ Ð¿Ñ€ÐµÐ´Ð¿Ñ€Ð¸ÑÑ‚Ð¸Ð¹ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ñ Ñ€Ð¾ÑÑÐ¸Ñ',
            'Ð³Ð¾ÑÐºÐ¾Ð¼ÑÑ‚Ð°Ñ‚ Ð¾Ð±Ñ‰ÐµÐ¿Ð¸Ñ‚ Ð¼Ð¾ÑÐºÐ²Ð° 2024 Ð³Ð¾Ð´'
          ];

          for (const officialQuery of officialQueries) {
            try {
              const officialSearch = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(officialQuery)}&format=json&no_html=1&skip_disambig=1`, {
                dispatcher: proxyAgent
              });
              if (officialSearch.ok) {
                const data = await officialSearch.json();
                if (data.AbstractText && data.AbstractText.length > 50) {
                  searchResults += `ÐžÑ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° (${officialQuery}):\n`;
                  searchResults += `${data.AbstractText}\n\n`;
                }
              }
            } catch (queryError) {
              console.error('Official stats query error:', queryError);
            }
          }
        } catch (officialError) {
          console.error('Official statistics search error:', officialError);
        }

        // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº Ð² Wikipedia Ð´Ð»Ñ Ð±Ð¸Ð·Ð½ÐµÑ-ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸
        try {
          const wikiQueries = lowerQuery.includes('Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚') || lowerQuery.includes('ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€') || lowerQuery.includes('Ð¶Ð¸Ð»') ? [
            'ÐÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð² Ð Ð¾ÑÑÐ¸Ð¸', 'Ð Ñ‹Ð½Ð¾Ðº Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚Ð¸ ÐœÐ¾ÑÐºÐ²Ñ‹', 'Ð–Ð¸Ð»Ð¸Ñ‰Ð½Ð¾Ðµ ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÐµÐ»ÑŒÑÑ‚Ð²Ð¾ Ð² Ð Ð¾ÑÑÐ¸Ð¸', 'Ð¦ÐµÐ½Ñ‹ Ð½Ð° Ð¶Ð¸Ð»ÑŒÐµ Ð² ÐœÐ¾ÑÐºÐ²Ðµ'
          ] : [
            'ÐšÐ¾Ñ„ÐµÐ¹Ð½Ñ', 'Ð Ñ‹Ð½Ð¾Ðº ÐºÐ¾Ñ„Ðµ Ð² Ð Ð¾ÑÑÐ¸Ð¸', 'ÐšÐ¾Ñ„ÐµÐ¸Ð½Ð´ÑƒÑÑ‚Ñ€Ð¸Ñ', 'ÐšÐ¾Ñ„Ðµ Ð² Ð Ð¾ÑÑÐ¸Ð¸', 'ÐžÐ±Ñ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ðµ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ðµ Ð² Ð Ð¾ÑÑÐ¸Ð¸'
          ];
          for (const wikiQuery of wikiQueries) {
            const wikiResponse = await fetch(`https://ru.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(wikiQuery)}`, {
              dispatcher: proxyAgent
            });
            if (wikiResponse.ok) {
              const wikiData = await wikiResponse.json();
              if (wikiData.extract && (
                (lowerQuery.includes('Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚') || lowerQuery.includes('ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€') || lowerQuery.includes('Ð¶Ð¸Ð»')) ?
                  (wikiData.extract.includes('Ð½ÐµÐ´Ð²Ð¸Ð¶Ð¸Ð¼Ð¾ÑÑ‚') || wikiData.extract.includes('Ð¶Ð¸Ð»') || wikiData.extract.includes('ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€') || wikiData.extract.includes('Ñ€Ñ‹Ð½Ð¾Ðº')) :
                  (wikiData.extract.includes('ÐºÐ¾Ñ„Ðµ') || wikiData.extract.includes('Ñ€Ñ‹Ð½Ð¾Ðº') || wikiData.extract.includes('Ð¿Ð¸Ñ‚Ð°Ð½Ð¸'))
              )) {
                // Ð˜Ñ‰ÐµÐ¼ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ñ‚ÐµÐºÑÑ‚Ðµ
                const numbersFound = wikiData.extract.match(/\d{1,3}(?:[.,]\d{3})*(?:\s*(?:Ñ‚Ñ‹Ñ\.?|Ð¼Ð»Ð½\.?|Ð¼Ð»Ñ€Ð´\.?)?\s*Ñ€ÑƒÐ±\.?|\s*Ñ€ÑƒÐ±Ð»ÐµÐ¹?|\s*\%)/gi);
                if (numbersFound && numbersFound.length > 0) {
                  searchResults += `Ð˜Ð· Wikipedia (${wikiQuery}) - Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ðµ:\n`;
                  searchResults += `${numbersFound.join(', ')}\n`;
                  searchResults += `${wikiData.extract.substring(0, 300)}...\n\n`;
                }
              }
            }
          }
        } catch (wikiError) {
          console.error('Wikipedia business search error:', wikiError);
        }

        // ÐŸÐ¾Ð¸ÑÐº Ð² Ð°Ð½Ð³Ð»Ð¾ÑÐ·Ñ‹Ñ‡Ð½Ð¾Ð¹ Wikipedia Ð´Ð»Ñ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
        try {
          const enWikiQueries = ['Coffeehouse', 'Coffee industry in Russia', 'Coffee market', 'Foodservice industry in Russia'];
          for (const wikiQuery of enWikiQueries) {
            const wikiResponse = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(wikiQuery)}`, {
              dispatcher: proxyAgent
            });
            if (wikiResponse.ok) {
              const wikiData = await wikiResponse.json();
              if (wikiData.extract && (wikiData.extract.includes('Russia') || wikiData.extract.includes('market') || wikiData.extract.includes('coffee'))) {
                // Ð˜Ñ‰ÐµÐ¼ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ð°Ð½Ð³Ð»Ð¾ÑÐ·Ñ‹Ñ‡Ð½Ð¾Ð¼ Ñ‚ÐµÐºÑÑ‚Ðµ
                const numbersFound = wikiData.extract.match(/\d{1,3}(?:[,.]\d{3})*(?:\s*(?:thousand|million|billion)?\s*(?:rubles?|USD|\$|â‚¬|%|percent))/gi);
                if (numbersFound && numbersFound.length > 0) {
                  searchResults += `From English Wikipedia (${wikiQuery}) - found data:\n`;
                  searchResults += `${numbersFound.join(', ')}\n`;
                  searchResults += `${wikiData.extract.substring(0, 300)}...\n\n`;
                }
              }
            }
          }
        } catch (enWikiError) {
          console.error('English Wikipedia business search error:', enWikiError);
        }
      } catch (businessError) {
        console.error('Business data search error:', businessError);
      }
    }

    // 7. ÐŸÐ¾Ð¸ÑÐº Ð½Ð¾Ð²Ð¾ÑÑ‚ÐµÐ¹ Ñ‡ÐµÑ€ÐµÐ· NewsAPI (Ð´ÐµÐ¼Ð¾ Ð²ÐµÑ€ÑÐ¸Ñ)
    if (lowerQuery.includes('Ð½Ð¾Ð²Ð¾ÑÑ‚') || lowerQuery.includes('ÑÐ¾Ð±Ñ‹Ñ‚Ð¸') ||
        (lowerQuery.includes('Ð±Ð¸Ð·Ð½ÐµÑ') || lowerQuery.includes('Ñ€Ñ‹Ð½Ð¾Ðº'))) {
      try {
        // Ð”Ð»Ñ Ð±Ð¸Ð·Ð½ÐµÑ-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¸Ñ‰ÐµÐ¼ Ð±Ð¸Ð·Ð½ÐµÑ-Ð½Ð¾Ð²Ð¾ÑÑ‚Ð¸
        const searchQuery = lowerQuery.includes('Ð±Ð¸Ð·Ð½ÐµÑ') || lowerQuery.includes('Ñ€Ñ‹Ð½Ð¾Ðº') || lowerQuery.includes('ÐºÐ¾Ñ„Ðµ')
          ? `${encodedQuery} Ð±Ð¸Ð·Ð½ÐµÑ Ñ€Ð¾ÑÑÐ¸Ñ`
          : encodedQuery;

        const newsResponse = await fetch(`https://newsapi.org/v2/everything?q=${searchQuery}&language=ru&sortBy=publishedAt&pageSize=5&apiKey=demo`, {
          dispatcher: proxyAgent
        });
        if (newsResponse.ok) {
          const newsData = await newsResponse.json();
          if (newsData.articles && newsData.articles.length > 0) {
            searchResults += `ÐÐ¾Ð²Ð¾ÑÑ‚Ð¸ Ð¸ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ°:\n`;
            newsData.articles.slice(0, 3).forEach((article, index) => {
              if (article.title && (article.title.toLowerCase().includes('ÐºÐ¾Ñ„Ðµ') ||
                  article.title.toLowerCase().includes('Ð±Ð¸Ð·Ð½ÐµÑ') ||
                  article.title.toLowerCase().includes('Ñ€Ñ‹Ð½Ð¾Ðº') ||
                  article.title.toLowerCase().includes('Ð¿Ñ€Ð¸Ð±Ñ‹Ð»') ||
                  article.title.toLowerCase().includes('Ð²Ñ‹Ñ€ÑƒÑ‡Ðº') ||
                  article.title.toLowerCase().includes('ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸Ðº'))) {
                searchResults += `${index + 1}. ${article.title}\n`;
                if (article.description) {
                  // Ð˜Ñ‰ÐµÐ¼ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ð¸ Ð½Ð¾Ð²Ð¾ÑÑ‚Ð¸
                  const numbersInDesc = article.description.match(/\d{1,3}(?:[.,]\d{3})*(?:\s*(?:Ñ‚Ñ‹Ñ\.?|Ð¼Ð»Ð½\.?|Ð¼Ð»Ñ€Ð´\.?)?\s*Ñ€ÑƒÐ±\.?|\s*Ñ€ÑƒÐ±Ð»ÐµÐ¹?|\s*\%)/gi);
                  if (numbersInDesc && numbersInDesc.length > 0) {
                    searchResults += `   ÐÐ°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ: ${numbersInDesc.join(', ')}\n`;
                  }
                  searchResults += `   ${article.description.substring(0, 150)}...\n`;
                }
                searchResults += `   Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº: ${article.source.name}\n\n`;
              }
            });
          }
        }
      } catch (newsError) {
        console.error('News API error:', newsError);
      }
    }

    // 6. Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ñ‡ÐµÑ€ÐµÐ· Stack Exchange
    if (lowerQuery.includes('ÐºÐ°Ðº') || lowerQuery.includes('Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ') || lowerQuery.includes('Ð¾ÑˆÐ¸Ð±Ðº') || lowerQuery.includes('Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸')) {
      try {
        const stackResponse = await fetch(`https://api.stackexchange.com/2.3/search?order=desc&sort=relevance&tagged=javascript&intitle=${encodedQuery}&site=stackoverflow`, {
          dispatcher: proxyAgent
        });
        if (stackResponse.ok) {
          const stackData = await stackResponse.json();
          if (stackData.items && stackData.items.length > 0) {
            searchResults += `Ð˜Ð· Stack Overflow:\n`;
            stackData.items.slice(0, 2).forEach((item, index) => {
              if (item.title) {
                searchResults += `${index + 1}. ${item.title}\n`;
                if (item.tags && item.tags.length > 0) {
                  searchResults += `   Ð¢ÐµÐ³Ð¸: ${item.tags.slice(0, 3).join(', ')}\n`;
                }
                searchResults += `   Ð¡ÑÑ‹Ð»ÐºÐ°: https://stackoverflow.com/questions/${item.question_id}\n\n`;
              }
            });
          }
        }
      } catch (stackError) {
        console.error('Stack Exchange error:', stackError);
      }
    }

    // Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¸Ð»Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
    const finalResult = searchResults || '[NO_RESULTS_FOUND]';

    res.json({
      query,
      results: finalResult,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('Web search API error:', error);
    res.status(500).json({
      error: 'Failed to perform web search',
      details: error.message
    });
  }
});

// OpenAI Chat API proxy (Ð¾Ð±Ñ…Ð¾Ð´ CORS Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹)
app.post('/api/chat', async (req, res) => {
  try {
    const { messages, model = 'gpt-4o-mini', stream = false } = req.body;

    if (!messages || !Array.isArray(messages)) {
      return res.status(400).json({ error: 'Messages array is required' });
    }

    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ API ÐºÐ»ÑŽÑ‡ Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°
    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) {
      return res.status(500).json({ error: 'OpenAI API key not configured on server' });
    }

    const openaiResponse = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`,
      },
      dispatcher: proxyAgent,
      body: JSON.stringify({
        model: model === 'pro' ? 'gpt-4o' : 'gpt-4o-mini',
        messages,
        stream,
        temperature: 0.7,
        max_tokens: model === 'pro' ? 8000 : 4000, // Ð‘Ð¾Ð»ÑŒÑˆÐµ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð² Ð´Ð»Ñ Pro Ð¼Ð¾Ð´ÐµÐ»Ð¸
      }),
    });

    if (!openaiResponse.ok) {
      const errorText = await openaiResponse.text();
      console.error('OpenAI API error:', openaiResponse.status, errorText);
      return res.status(openaiResponse.status).json({
        error: 'OpenAI API error',
        details: errorText
      });
    }

    if (stream) {
      // Ð”Ð»Ñ Ð¿Ð¾Ñ‚Ð¾ÐºÐ¾Ð²Ñ‹Ñ… Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð² Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ð¿Ð¾Ñ‚Ð¾Ðº Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ
      res.setHeader('Content-Type', 'text/plain; charset=utf-8');
      res.setHeader('Cache-Control', 'no-cache');
      res.setHeader('Connection', 'keep-alive');

      const reader = openaiResponse.body.getReader();
      const decoder = new TextDecoder();

      try {
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value);
          res.write(chunk);
        }
      } finally {
        res.end();
      }
    } else {
      // Ð”Ð»Ñ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ñ… Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð² Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ JSON
      const data = await openaiResponse.json();
      res.json(data);
    }

  } catch (error) {
    console.error('Chat API proxy error:', error);
    res.status(500).json({
      error: 'Failed to process chat request',
      details: error.message
    });
  }
});

// ÐÐ½Ð°Ð»Ð¸Ð· Ð½Ð°Ð¼ÐµÑ€ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ IT-Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚
app.post('/api/analyze-intent', async (req, res) => {
  try {
    const { query, task } = req.body;

    if (!query) {
      return res.status(400).json({ error: 'Query is required' });
    }

    const API_KEY = process.env.OPENAI_API_KEY;
    if (!API_KEY) {
      console.error('OpenAI API key not found');
      return res.status(500).json({ error: 'API key not configured' });
    }

    // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ gpt-4o-mini Ð´Ð»Ñ ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          {
            role: 'system',
            content: 'Ð¢Ñ‹ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑˆÑŒ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹. ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸, Ñ…Ð¾Ñ‡ÐµÑ‚ Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ IT-Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚ (ÑÐ°Ð¹Ñ‚, Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ, ÐºÐ¾Ð´, Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ñƒ, API, Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ð½Ð¾Ðµ Ð¾Ð±ÐµÑÐ¿ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð¸ Ñ‚.Ð´.). Ð’ÐµÑ€Ð½Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ "true" Ð¸Ð»Ð¸ "false".'
          },
          {
            role: 'user',
            content: `Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: "${query}"\n\nÐ­Ñ‚Ð¾ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ IT-Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ð°? Ð’ÐµÑ€Ð½Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ true Ð¸Ð»Ð¸ false.`
          }
        ],
        max_tokens: 10,
        temperature: 0.1,
      }),
      dispatcher: proxyAgent
    });

    if (!response.ok) {
      console.error('OpenAI API error:', response.status, response.statusText);
      return res.status(500).json({ error: 'Failed to analyze intent' });
    }

    const data = await response.json();
    const result = data.choices[0]?.message?.content?.trim().toLowerCase();

    const isCodingIntent = result === 'true' || result === 'Ð´Ð°' || result === 'yes';

    res.json({ isCodingIntent });

  } catch (error) {
    console.error('Error in analyze-intent:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

// Health check
app.get('/api/health', (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() });
});

// Serve static files from dist directory
app.use(express.static(path.join(__dirname, 'dist')));

// SPA fallback - all non-API routes should return index.html
app.use((req, res, next) => {
  // Don't serve index.html for API routes
  if (req.path.startsWith('/api/')) {
    return res.status(404).json({ error: 'API endpoint not found' });
  }
  // For all other routes, serve index.html
  res.sendFile(path.join(__dirname, 'dist', 'index.html'));
});

// Start server
app.listen(PORT, () => {
  console.log(`ðŸš€ Server running on https://ai.windexs.ru`);
  console.log(`ðŸ“¦ Serving static files from dist/`);
});

// Graceful shutdown
process.on('SIGINT', () => {
  console.log('ðŸ›‘ Shutting down API server...');
  DatabaseService.close();
  process.exit(0);
});

process.on('SIGTERM', () => {
  console.log('ðŸ›‘ Shutting down API server...');
  DatabaseService.close();
  process.exit(0);
});
