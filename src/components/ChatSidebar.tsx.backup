import { MessageSquare, User, Plus, Menu, Trash2 } from "lucide-react";
import { NavLink } from "@/components/NavLink";
import {
  Sidebar,
  SidebarContent,
  SidebarGroup,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarMenu,
  SidebarMenuItem,
  SidebarMenuButton,
  SidebarTrigger,
  useSidebar,
} from "@/components/ui/sidebar";
import { Button } from "@/components/ui/button";
import { useState, useEffect } from "react";
import { apiClient, type ChatSession } from "@/lib/api";

interface ChatSidebarProps {
  onNewChat: () => void;
  onSelectChat: (sessionId: number) => void;
  currentSessionId?: number | null;
  refreshTrigger?: number; // Для обновления списка чатов
  onChatDeleted?: () => void; // Колбэк при удалении чата
}

export function ChatSidebar({ onNewChat, onSelectChat, currentSessionId, refreshTrigger, onChatDeleted }: ChatSidebarProps) {
  const { state } = useSidebar();
  const collapsed = state === "collapsed";
  const [chatSessions, setChatSessions] = useState<ChatSession[]>([]);
  const [loading, setLoading] = useState(true);
  const [contextMenu, setContextMenu] = useState<{
    visible: boolean;
    x: number;
    y: number;
    sessionId: number | null;
    sessionTitle: string;
  }>({
    visible: false,
    x: 0,
    y: 0,
    sessionId: null,
    sessionTitle: '',
  });

  // Загрузка чатов при монтировании компонента и при refreshTrigger
  useEffect(() => {
    const loadChatSessions = async () => {
      try {
        const sessions = await apiClient.getAllSessions();
        setChatSessions(sessions);
      } catch (error) {
        console.error('Error loading chat sessions:', error);
      } finally {
        setLoading(false);
      }
    };

    loadChatSessions();
  }, [refreshTrigger]);

  // Функция для форматирования даты
  const formatDate = (timestamp: number): string => {
    const now = new Date();
    const date = new Date(timestamp);
    const diffTime = Math.abs(now.getTime() - date.getTime());
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays === 0) {
      return 'Сегодня';
    } else if (diffDays === 1) {
      return 'Вчера';
    } else if (diffDays < 7) {
      return `${diffDays} дня назад`;
    } else {
      return date.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'short'
      });
    }
  };

  const handleChatClick = (sessionId: number) => {
    onSelectChat(sessionId);
  };

  const handleDeleteChat = async (sessionId: number, sessionTitle: string) => {
    // Проверяем, является ли этот чат текущим активным
    if (currentSessionId === sessionId) {
      alert('Нельзя удалить активный чат. Сначала переключитесь на другой чат.');
      return;
    }

    // Проверяем, является ли этот чат последним
    if (chatSessions.length <= 1) {
      alert('Нельзя удалить последний чат. Создайте новый чат перед удалением этого.');
      return;
    }

    try {
      await apiClient.deleteSession(sessionId);
      // Обновляем список чатов
      const updatedSessions = await apiClient.getAllSessions();
      setChatSessions(updatedSessions);
      // Уведомляем родительский компонент об удалении
      if (onChatDeleted) {
        onChatDeleted();
      }
    } catch (error) {
      console.error('Error deleting chat session:', error);
      alert('Ошибка при удалении чата');
    }
  };

  const handleContextMenu = (e: React.MouseEvent, sessionId: number, sessionTitle: string) => {
    e.preventDefault();
    e.stopPropagation();

    setContextMenu({
      visible: true,
      x: e.clientX,
      y: e.clientY,
      sessionId,
      sessionTitle,
    });
  };

  const handleCloseContextMenu = () => {
    setContextMenu(prev => ({ ...prev, visible: false }));
  };

  // Закрываем контекстное меню при клике вне его
  useEffect(() => {
    const handleClickOutside = () => {
      handleCloseContextMenu();
    };

    if (contextMenu.visible) {
      document.addEventListener('click', handleClickOutside);
      return () => document.removeEventListener('click', handleClickOutside);
    }
  }, [contextMenu.visible]);

  return (
    <div className="relative">
      <Sidebar className={collapsed ? "w-14" : "w-64"} collapsible="icon" side="left">
        <SidebarContent className="bg-background border-r border-border">
          <div className="p-4 flex items-center justify-between">
            {!collapsed && (
              <h2 className="text-lg font-semibold text-foreground">WindexsAI</h2>
            )}
            <SidebarTrigger className="ml-auto" />
          </div>

          <div className="px-2 mb-4">
            <Button
              onClick={onNewChat}
              className="w-full gap-2 bg-primary hover:bg-primary/90"
              size={collapsed ? "icon" : "default"}
            >
              <Plus className="h-4 w-4" />
              {!collapsed && <span>Новый чат</span>}
            </Button>
          </div>

          <SidebarGroup>
            {!collapsed && (
              <SidebarGroupLabel className="text-muted-foreground px-4">
                История чатов
              </SidebarGroupLabel>
            )}
            <SidebarGroupContent>
              <SidebarMenu>
                {loading ? (
                  // Показываем загрузку
                  <div className="px-2 py-4 text-center text-muted-foreground">
                    {!collapsed && <span className="text-xs">Загрузка...</span>}
                  </div>
                ) : chatSessions.length === 0 ? (
                  // Показываем сообщение если чатов нет
                  <div className="px-2 py-4 text-center text-muted-foreground">
                    {!collapsed && <span className="text-xs">Нет чатов</span>}
                  </div>
                ) : (
                  // Показываем список чатов
                  chatSessions.map((session) => (
                    <SidebarMenuItem key={session.id}>
                      <div
                        className={`relative group ${!collapsed ? 'w-full' : ''}`}
                        onContextMenu={(e) => handleContextMenu(e, session.id!, session.title)}
                      >
                        <SidebarMenuButton
                          onClick={() => handleChatClick(session.id!)}
                          className={`hover:bg-muted/50 flex items-center gap-2 w-full ${
                            currentSessionId === session.id ? 'bg-muted text-primary' : ''
                          }`}
                        >
                          <MessageSquare className="h-4 w-4 shrink-0" />
                          {!collapsed && (
                            <div className="flex-1 overflow-hidden">
                              <p className="text-sm truncate">{session.title}</p>
                              <p className="text-xs text-muted-foreground">
                                {formatDate(session.updated_at)}
                              </p>
                            </div>
                          )}
                        </SidebarMenuButton>

                        {/* Кнопка удаления при наведении */}
                        {!collapsed && (
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              handleDeleteChat(session.id!, session.title);
                            }}
                            className="absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded-md opacity-0 group-hover:opacity-100 hover:bg-destructive/10 hover:text-destructive transition-all duration-200"
                            title="Удалить чат"
                          >
                            <Trash2 className="h-3 w-3" />
                          </button>
                        )}
                      </div>
                    </SidebarMenuItem>
                  ))
                )}
              </SidebarMenu>
            </SidebarGroupContent>
          </SidebarGroup>

          <div className="mt-auto p-2 border-t border-border">
            <SidebarMenuButton asChild>
              <NavLink
                to="/profile"
                className="hover:bg-muted/50 flex items-center gap-2 w-full"
                activeClassName="bg-muted text-primary"
              >
                <User className="h-4 w-4 shrink-0" />
                {!collapsed && <span>Личный кабинет</span>}
              </NavLink>
            </SidebarMenuButton>
          </div>
        </SidebarContent>
      </Sidebar>

      {/* Контекстное меню */}
      {contextMenu.visible && (
        <div
          className="fixed z-50 bg-background border border-border rounded-md shadow-lg py-1 min-w-[160px]"
          style={{
            left: contextMenu.x,
            top: contextMenu.y,
          }}
        >
          <button
            onClick={() => {
              if (contextMenu.sessionId && contextMenu.sessionTitle) {
                handleDeleteChat(contextMenu.sessionId, contextMenu.sessionTitle);
              }
              handleCloseContextMenu();
            }}
            className="w-full px-3 py-2 text-left text-sm hover:bg-destructive/10 hover:text-destructive flex items-center gap-2"
          >
            <Trash2 className="h-4 w-4" />
            Удалить чат
          </button>
        </div>
      )}
    </div>
  );
}
